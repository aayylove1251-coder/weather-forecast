<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Shengang Hourly Weather Forecast</title>
    <style>
        body {
            font-family: "Segoe UI", Arial, sans-serif;
            background: linear-gradient(to bottom, #e0f7fa, #ffffff);
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 950px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        h1 {
            background: #0288d1;
            color: white;
            margin: 0;
            padding: 20px;
            text-align: center;
            font-size: 1.5rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px 10px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }
        th {
            background: #f5f5f5;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.85rem;
        }
        tr:nth-child(even) {
            background: #fafafa;
        }
        .time { font-weight: bold; }
        .temp { font-size: 1.2em; color: #d32f2f; font-weight: bold; }
        .rain { color: #1976d2; font-weight: bold; }
        .loading {
            text-align: center;
            padding: 60px;
            font-size: 1.2em;
            color: #555;
        }
        .error {
            color: #c62828;
            text-align: center;
            padding: 40px;
        }
        .icon {
            width: 48px;
            height: 48px;
            vertical-align: middle;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Hourly Weather Forecast - Shengang Township</h1>
    
    <div id="loading" class="loading">Fetching latest weather data...</div>
    <div id="error" class="error" style="display:none;"></div>
    
    <table id="weatherTable" style="display:none;">
        <thead>
            <tr>
                <th>Time</th>
                <th>Condition</th>
                <th>Temp</th>
                <th>Feels Like</th>
                <th>Rain Prob.</th>
                <th>Precip.</th>
                <th>Wind</th>
                <th>Humidity</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<script>
// Coordinates - Shengang Township, Changhua
const lat = 24.164524;
const lon = 120.479517;

const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
               `&hourly=temperature_2m,apparent_temperature,precipitation_probability,precipitation,relative_humidity_2m,weathercode,wind_speed_10m` +
               `&forecast_days=2&timezone=Asia%2FTaipei&windspeed_unit=kmh&precipitation_unit=mm`;

function fetchWeather() {
    fetch(apiUrl)
        .then(response => {
            if (!response.ok) throw new Error("Network error. Please try again later.");
            return response.json();
        })
        .then(data => {
            document.getElementById("loading").style.display = "none";
            if (!data.hourly) {
                showError("Could not retrieve weather data.");
                return;
            }
            updateTable(data);
            document.getElementById("weatherTable").style.display = "table";
        })
        .catch(err => {
            showError("Error: " + err.message);
            console.error(err);
        });
}

function updateTable(data) {
    const tbody = document.getElementById("tableBody");
    tbody.innerHTML = ""; // Clear existing rows

    const times = data.hourly.time;
    const temp = data.hourly.temperature_2m;
    const appTemp = data.hourly.apparent_temperature;
    const rainProb = data.hourly.precipitation_probability;
    const rain = data.hourly.precipitation;
    const humidity = data.hourly.relative_humidity_2m;
    const wind = data.hourly.wind_speed_10m;
    const codes = data.hourly.weathercode;

    const now = new Date();
    // Get current index in hourly array
    const nowISO = now.toISOString().slice(0, 13); // "YYYY-MM-DDTHH"
    let startIndex = times.findIndex(t => t.startsWith(nowISO));
    if (startIndex === -1) startIndex = 0;

    // Display next 24 hours
    for (let i = startIndex; i < startIndex + 24; i++) {
        if (i >= times.length) break;

        const dateObj = new Date(times[i]);
        const timeStr = dateObj.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
        const isNow = i === startIndex;
        const row = document.createElement("tr");

        const weatherIcon = getWeatherIcon(codes[i]);
        const weatherDesc = getWeatherDesc(codes[i]);

        row.innerHTML = `
            <td class="time">${timeStr}${isNow ? '<br><small style="color:#0288d1">(Now)</small>' : ''}</td>
            <td><img class="icon" src="${weatherIcon}" alt="icon" title="${weatherDesc}"/><br><small>${weatherDesc}</small></td>
            <td class="temp">${temp[i]}°C</td>
            <td>${Math.round(appTemp[i])}°C</td>
            <td class="rain">${rainProb[i]}%</td>
            <td>${rain[i] === 0 ? '-' : rain[i]+'mm'}</td>
            <td>${wind[i]} <small>km/h</small></td>
            <td>${humidity[i]}%</td>
        `;
        tbody.appendChild(row);
    }
}

function showError(msg) {
    document.getElementById("loading").style.display = "none";
    const errDiv = document.getElementById("error");
    errDiv.textContent = msg;
    errDiv.style.display = "block";
}

function getWeatherIcon(code) {
    const icons = {
        0: "https://openweathermap.org/img/wn/01d@2x.png",   // Clear
        1: "https://openweathermap.org/img/wn/02d@2x.png",   // Mainly Clear
        2: "https://openweathermap.org/img/wn/03d@2x.png",   // Partly Cloudy
        3: "https://openweathermap.org/img/wn/04d@2x.png",   // Overcast
        45: "https://openweathermap.org/img/wn/50d@2x.png",  // Fog
        48: "https://openweathermap.org/img/wn/50d@2x.png",
        51: "https://openweathermap.org/img/wn/09d@2x.png",  // Drizzle
        53: "https://openweathermap.org/img/wn/09d@2x.png",
        55: "https://openweathermap.org/img/wn/09d@2x.png",
        61: "https://openweathermap.org/img/wn/10d@2x.png",  // Rain
        63: "https://openweathermap.org/img/wn/10d@2x.png",
        65: "https://openweathermap.org/img/wn/10d@2x.png",
        80: "https://openweathermap.org/img/wn/09d@2x.png",  // Showers
        81: "https://openweathermap.org/img/wn/09d@2x.png",
        82: "https://openweathermap.org/img/wn/09d@2x.png",
        95: "https://openweathermap.org/img/wn/11d@2x.png",  // Thunderstorm
    };
    return icons[code] || "https://openweathermap.org/img/wn/03d@2x.png";
}

function getWeatherDesc(code) {
    const desc = {
        0: "Clear Sky", 1: "Mainly Clear", 2: "Partly Cloudy", 3: "Overcast",
        45: "Fog", 48: "Depositing Rime Fog",
        51: "Light Drizzle", 53: "Moderate Drizzle", 55: "Dense Drizzle",
        61: "Slight Rain", 63: "Moderate Rain", 65: "Heavy Rain",
        80: "Slight Showers", 81: "Moderate Showers", 82: "Violent Showers",
        95: "Thunderstorm"
    };
    return desc[code] || "Unknown";
}

// Initial Call
fetchWeather();

// Automatic refresh every 60 minutes
setInterval(fetchWeather, 60 * 60 * 1000);

</script>
</body>
</html>
